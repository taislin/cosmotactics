name: Build and Release Neutralinojs App

on:
    push:
        branches:
            - master # Or 'main' if that's your primary branch
        paths:
            - "**.js"
            - "**.html"
            - "**.json"
            - "**.css"
            - ".github/workflows/release.yml"

jobs:
    build-and-release:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - name: Check out repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install project dependencies
              run: npm install

            - name: Create bundled JS for the app
              run: npm run build

            - name: Prepare Neutralino HTML entry point
              run: mv index.neutralino.html index.html

            - name: Install Neutralinojs CLI
              run: npm install -g @neutralinojs/neu

            # REMOVED: The 'neu update' step is no longer needed as the client is in the repo.

            - name: Build Neutralinojs App
              run: neu build

            - name: Determine Platform-specific Details
              id: platform
              shell: bash
              run: |
                  if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
                    echo "ASSET_NAME=cosmotactics-windows-x64.zip" >> $GITHUB_ENV
                    echo "ASSET_PATH=./cosmotactics-win_x64.zip" >> $GITHUB_ENV
                    echo "ARCHIVE_CMD=zip -r cosmotactics-win_x64.zip ./dist/*" >> $GITHUB_ENV
                  elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
                    echo "ASSET_NAME=cosmotactics-macOS-x64.zip" >> $GITHUB_ENV
                    echo "ASSET_PATH=./cosmotactics-mac_x64.zip" >> $GITHUB_ENV
                    echo "ARCHIVE_CMD=zip -r cosmotactics-mac_x64.zip ./dist/*" >> $GITHUB_ENV
                  else
                    echo "ASSET_NAME=cosmotactics-linux-x64.zip" >> $GITHUB_ENV
                    echo "ASSET_PATH=./cosmotactics-linux_x64.zip" >> $GITHUB_ENV
                    echo "ARCHIVE_CMD=zip -r cosmotactics-linux_x64.zip ./dist/*" >> $GITHUB_ENV
                  fi

            - name: Package application for release
              run: ${{ env.ARCHIVE_CMD }}

            - name: Create GitHub Release (only on Linux job)
              id: create_release
              if: matrix.os == 'ubuntu-latest'
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: build-${{ github.run_number }}
                  release_name: CosmoTactics Build ${{ github.run_number }}
                  body: "Automated multi-platform release. Triggered by commit ${{ github.sha }}."
                  draft: false
                  prerelease: false

            - name: Get Release URL
              id: get_release
              if: matrix.os != 'ubuntu-latest'
              uses: joutvhu/get-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: build-${{ github.run_number }}

            - name: Upload Release Asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url || steps.get_release.outputs.upload_url }}
                  asset_path: ${{ env.ASSET_PATH }}
                  asset_name: ${{ env.ASSET_NAME }}
                  asset_content_type: application/zip
