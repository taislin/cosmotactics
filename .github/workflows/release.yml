# D:\GitHub\minigame-menagerie\cosmotactics\.github\workflows\release.yml

name: Build and Release

on:
    push:
        branches:
            - main
            - master
        paths:
            - "**.js"
            - "**.html"
            - "**.json"
            - "**.css"
            - ".github/workflows/release.yml"
    workflow_dispatch:
        inputs:
            bump_level:
                description: "Which version number to bump?"
                required: true
                default: "patch"
                type: choice
                options:
                    - patch
                    - minor
                    - major

jobs:
    bump-version:
        if: "!contains(github.event.head_commit.message, 'chore(release):')"
        runs-on: ubuntu-latest
        permissions:
            contents: write
        outputs:
            new_version: ${{ steps.get_version.outputs.version }}

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Configure Git
              run: |
                  git config --global user.name 'GitHub Actions Bot'
                  git config --global user.email 'github-actions-bot@users.noreply.github.com'

            - name: Determine Bump Level
              id: bump_level
              run: |
                  BUMP_LEVEL=${{ github.event.inputs.bump_level || 'patch' }}
                  echo "BUMP_LEVEL=$BUMP_LEVEL" >> $GITHUB_ENV

            - name: Bump Version and Create Tag
              run: |
                  npm version ${{ env.BUMP_LEVEL }} -m "chore(release): bump version to %s"

            - name: Push Changes and Tags
              run: git push --follow-tags

            - name: Get New Version
              id: get_version
              run: |
                  echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
